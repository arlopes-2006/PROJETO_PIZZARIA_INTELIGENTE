<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üçï Pizzaria Inteligente ‚Äî Pedido (com Frete por Endere√ßo)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

  :root{ --bg1:#FFEDD5; --bg2:#F97316; --accent:#ea580c; --accent-dark:#c2410c; --card:#fff7e6; --text:#3B1F0B; }
  *{box-sizing:border-box}
  body{ font-family:'Roboto',sans-serif; margin:0; background: linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%); color:var(--text); padding:20px; }
  .container{ max-width:1000px; margin:0 auto; }
  header{ text-align:center; margin-bottom:12px; }
  header h1{ margin:6px 0; font-size:28px; text-shadow:1px 1px 3px #b75c00; display:inline-block; }

  .section-box{ background:var(--card); border-radius:10px; padding:16px; box-shadow:0 6px 16px rgba(0,0,0,0.12); margin-bottom:14px; }
  h2{ margin-top:0; border-bottom:2px solid #b75c00; padding-bottom:6px; font-size:18px; }
  label{ display:block; margin-top:8px; font-weight:600; }
  input[type="number"], input[type="text"], select, textarea{ width:100%; padding:10px; border-radius:6px; border:2px solid #b75c00; margin-top:6px; box-sizing:border-box; font-size:15px; }
  input:focus, select:focus, textarea:focus{ outline:none; border-color:var(--accent); }
  button{ margin-top:10px; background:var(--accent); color:#fff; border:none; padding:10px 12px; border-radius:9px; cursor:pointer; font-weight:700; width:100%; box-shadow:0 4px 6px rgba(0,0,0,0.12); }
  button.small{ width:auto; padding:8px 10px; font-size:14px; }
  .muted{ color:#6b4b2b; font-size:14px; }

  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .col{ flex:1; min-width:150px; }
  ul { padding-left:1rem; }
  .carrinho ul li{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
  .remove{ background:#b91c1c; color:white; padding:6px 8px; border-radius:6px; border:none; cursor:pointer; font-weight:700; }
  .entrega-box { margin-top:10px; padding:10px; background:#fff3e0; border-radius:8px; border:1px solid #f2c7a0; }
  .recibo{ background:#fff; border:2px dashed var(--accent); padding:12px; border-radius:10px; }

  @media (max-width:820px){ .row{ flex-direction:column; align-items:flex-start; } }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üçï Pizzaria Inteligente ‚Äî Pedido</h1>
      <p class="muted">Agora com c√°lculo de frete autom√°tico por endere√ßo (ou geolocaliza√ß√£o) + extras</p>
    </header>

    <div class="section-box pedido">
      <h2>Fazer Pedido</h2>
      <label>Quantas pessoas v√£o comer?
        <input type="number" id="numPessoas" min="1" value="1" />
      </label>

      <label>Apetite m√©dio:
        <select id="apetite">
          <option value="baixo">Baixo</option>
          <option value="normal" selected>Normal</option>
          <option value="alto">Alto</option>
        </select>
      </label>

      <label>Adicionar bebidas (opcional):</label>
      <div class="row">
        <label class="col"><input type="checkbox" id="bebidaRefrigerante"> Refrigerante (R$ 8,00)</label>
        <label class="col"><input type="checkbox" id="bebidaSuco"> Suco (R$ 7,00)</label>
      </div>

      <button id="btnCalcular">Calcular sugest√£o de pizzas</button>

      <div id="sugestaoContainer" style="display:none; margin-top:12px;">
        <p class="muted">üçΩÔ∏è Sugest√£o: <strong><span id="sugestaoQtd"></span></strong> pizza(s) para <span id="sugestaoPessoas"></span> pessoa(s) (apetite: <span id="sugestaoApetite"></span>).</p>
        <label>Deseja usar essa sugest√£o?
          <select id="usarSugestao"><option value="sim" selected>Sim</option><option value="nao">N√£o</option></select>
        </label>
        <div id="inputManualQtd" style="display:none; margin-top:8px;">
          <label>Quantidade manual de pizzas:
            <input type="number" id="qtdManual" min="1" value="1" />
          </label>
        </div>
        <button id="btnConfirmPedido">Confirmar Pedido</button>
      </div>

      <div id="pedidosLista" style="margin-top:12px;"><p><em>Nenhum pedido adicionado ainda.</em></p></div>
    </div>

    <div class="section-box sabores" style="display:none;">
      <h2>Escolha os sabores por pizza</h2>
      <div id="painelPizzas"></div>
      <button id="btnConfirmSabores" disabled>Confirmar Sabores e Adicionar ao Carrinho</button>
      <p class="muted">Para cada pizza voc√™ decide se ser√° inteira (1 sabor) ou meia/meia (2 sabores).</p>
    </div>

    <div class="section-box carrinho" style="display:none;">
      <h2>üõí Carrinho de Pedidos</h2>
      <div id="carrinhoLista"></div>

      <div class="entrega-box">
        <label>Retirada ou Delivery?</label>
        <div class="row">
          <label><input type="radio" name="tipoEntregaCarrinho" value="retirada" checked> Retirada na loja</label>
          <label><input type="radio" name="tipoEntregaCarrinho" value="delivery"> Delivery</label>
        </div>

        <div id="entregaDetalhes" style="margin-top:8px; display:none;">
          <label>Endere√ßo (rua, n√∫mero, bairro, cidade):
            <input type="text" id="enderecoCliente" placeholder="Ex: Rua A, 123, Centro, S√£o Paulo" />
          </label>
          <div class="row">
            <button id="btnUsarGeolocalizacao" class="small">Usar minha localiza√ß√£o (GPS)</button>
            <button id="btnGeocodificarEndereco" class="small">Calcular pelo endere√ßo</button>
          </div>

          <p style="margin-top:8px;">Ou insira a dist√¢ncia manualmente (km):
            <input type="number" id="distanciaManual" min="0" step="0.1" value="0" style="width:120px; display:inline-block; margin-left:8px;" />
            <button id="btnUsarDistanciaManual" class="small">Aplicar</button>
          </p>

          <p style="margin-top:8px;">Dist√¢ncia estimada: <strong><span id="distanciaEstimativa">0.0</span> km</strong></p>
          <p>Taxa de entrega: R$ <strong id="taxaEntregaValor">0.00</strong></p>
          <p class="small">Taxa = TAXA_FIXA + TAXA_POR_KM √ó km (configur√°vel)</p>
        </div>
      </div>

      <p style="font-weight:bold; margin-top:12px;">Total (com entrega): R$ <span id="carrinhoTotal">0.00</span></p>
      <button id="btnFinalizarPedido">Finalizar Pedido</button>
    </div>

    <div class="section-box pagamento" style="display:none;">
      <h2>üí≥ Pagamento & Entrega</h2>
      <label>Seu nome:
        <input type="text" id="nomeCliente" placeholder="Digite seu nome" />
      </label>

      <label>Observa√ß√µes / Complemento de endere√ßo (opcional):
        <textarea id="obsEndereco" rows="2" placeholder="Ex: Campainha vermelha"></textarea>
      </label>

      <p><strong>Resumo do pedido:</strong></p>
      <ul id="pagamentoResumo"></ul>

      <p><strong>Total a pagar: R$ <span id="totalPagamento"></span></strong></p>

      <label>Forma de pagamento:
        <select id="formaPagamento"><option value="cartao">Cart√£o</option><option value="pix">Pix</option><option value="dinheiro">Dinheiro</option></select>
      </label>

      <p class="muted" id="tempoEstimadoInfo">Tempo estimado: <strong><span id="tempoEstimado">15</span> minutos</strong></p>
      <button id="btnConfirmarPagamento">Confirmar Pagamento</button>
    </div>

    <div class="section-box recibo" style="display:none;">
      <h2>üßæ Recibo do Pedido</h2>
      <p><strong>Nome do Cliente:</strong> <span id="reciboNome"></span></p>
      <p><strong>C√≥digo do Pedido:</strong> <span id="reciboCodigo"></span></p>
      <p><strong>Tipo de Entrega:</strong> <span id="reciboTipoEntrega"></span></p>
      <p><strong>Tempo Estimado:</strong> <span id="reciboTempo"></span> minutos</p>
      <p><strong>Taxa de entrega:</strong> R$ <span id="reciboTaxa"></span></p>
      <p><strong>Valor Total:</strong> R$ <span id="reciboTotal"></span></p>
      <p><strong>Resumo:</strong></p>
      <ul id="reciboResumo"></ul>
      <p style="text-align:center; font-weight:bold; color:#16a34a;">‚úÖ Pagamento confirmado! Obrigado pela prefer√™ncia.</p>
    </div>

    <footer style="text-align:center; margin-top:8px; font-size:13px; color:#6b4b2b;">Gerado: Pizzaria Inteligente ‚Äî Frete por Endere√ßo</footer>
  </div>
  <script>
(() => {
  // CONFIG
  const fatorPorApetite = { baixo: 0.3, normal: 0.5, alto: 0.75 };
  const precoPizza = 40.00; // R$
  const precoRefrigerante = 8.00;
  const precoSuco = 7.00;
  const TAXA_FIXA = 3.00;    // R$
  const TAXA_POR_KM = 1.20;  // R$ por km
  const tempoRetirada = 15;  // minutos
  const tempoDelivery = 40;  // minutos

  const lojaCoords = { lat: -23.55052, lon: -46.633308 }; // exemplo: S√£o Paulo centro

  const saboresDisponiveis = ["Mussarela","Calabresa","Frango com Catupiry","Portuguesa","Marguerita","Quatro Queijos","Vegetariana","Pepperoni","Napolitana","Chocolate"];

  // ESTADO
  let pedidos = []; // array de pedidos (cada { pizzas: [...] })
  let pizzasSequencia = [];
  let taxaEntregaAtual = 0;
  let distanciaEstimativaKm = 0;
  let tipoEntregaAtual = 'retirada';

  // DOM
  const numPessoasInput = document.getElementById('numPessoas');
  const apetiteSelect = document.getElementById('apetite');
  const btnCalcular = document.getElementById('btnCalcular');
  const sugestaoContainer = document.getElementById('sugestaoContainer');
  const sugestaoQtdSpan = document.getElementById('sugestaoQtd');
  const sugestaoPessoasSpan = document.getElementById('sugestaoPessoas');
  const sugestaoApetiteSpan = document.getElementById('sugestaoApetite');
  const usarSugestaoSelect = document.getElementById('usarSugestao');
  const inputManualQtdDiv = document.getElementById('inputManualQtd');
  const qtdManualInput = document.getElementById('qtdManual');
  const btnConfirmPedido = document.getElementById('btnConfirmPedido');
  const pedidosLista = document.getElementById('pedidosLista');

  const bebidasCheckbox = { ref: document.getElementById('bebidaRefrigerante'), suco: document.getElementById('bebidaSuco') };

  const saboresSection = document.querySelector('.sabores');
  const painelPizzas = document.getElementById('painelPizzas');
  const btnConfirmSabores = document.getElementById('btnConfirmSabores');

  const carrinhoDiv = document.querySelector('.carrinho');
  const carrinhoLista = document.getElementById('carrinhoLista');
  const carrinhoTotal = document.getElementById('carrinhoTotal');
  const btnFinalizarPedido = document.getElementById('btnFinalizarPedido');

  const entregaDetalhes = document.getElementById('entregaDetalhes');
  const enderecoClienteInput = document.getElementById('enderecoCliente');
  const btnUsarGeolocalizacao = document.getElementById('btnUsarGeolocalizacao');
  const btnGeocodificarEndereco = document.getElementById('btnGeocodificarEndereco');
  const distanciaManualInput = document.getElementById('distanciaManual');
  const btnUsarDistanciaManual = document.getElementById('btnUsarDistanciaManual');
  const distanciaEstimativaSpan = document.getElementById('distanciaEstimativa');
  const taxaEntregaValorSpan = document.getElementById('taxaEntregaValor');

  const pagamentoDiv = document.querySelector('.pagamento');
  const pagamentoResumoUl = document.getElementById('pagamentoResumo');
  const totalPagamentoSpan = document.getElementById('totalPagamento');
  const nomeClienteInput = document.getElementById('nomeCliente');
  const btnConfirmarPagamento = document.getElementById('btnConfirmarPagamento');
  const tempoEstimadoSpan = document.getElementById('tempoEstimado');

  const reciboDiv = document.querySelector('.recibo');
  const reciboNome = document.getElementById('reciboNome');
  const reciboCodigo = document.getElementById('reciboCodigo');
  const reciboTotal = document.getElementById('reciboTotal');
  const reciboResumo = document.getElementById('reciboResumo');
  const reciboTipoEntrega = document.getElementById('reciboTipoEntrega');
  const reciboTempo = document.getElementById('reciboTempo');
  const reciboTaxa = document.getElementById('reciboTaxa');

  // UTILS
  function calcularPizzas(numPessoas, apetite) { const fator = fatorPorApetite[apetite] || 0.5; return Math.ceil(numPessoas * fator); }
  function formatMoney(v){ return Number(v).toFixed(2); }
  function haversineKm(aLat,aLon,bLat,bLon){
    function toRad(v){ return v*Math.PI/180; }
    const R=6371; const dLat=toRad(bLat-aLat); const dLon=toRad(bLon-aLon);
    const A=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLon/2)*Math.sin(dLon/2);
    const C=2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
    return R*C;
  }

  // --- atualizar UI de pedidos ---
  function atualizarPedidosListaVisivel(){
    if(pedidos.length === 0){ pedidosLista.innerHTML = '<p><em>Nenhum pedido adicionado ainda.</em></p>'; carrinhoDiv.style.display = 'none'; return; }
    let html = '<ul>';
    pedidos.forEach((pedido, i) => html += `<li><strong>Pedido #${i+1}:</strong> ${pedido.pizzas.length} pizza(s)</li>`);
    html += '</ul>';
    pedidosLista.innerHTML = html;
    atualizarCarrinhoVisual();
  }

  // --- criar painel pizzas ---
  function criarPainelPizzas(qtd){ painelPizzas.innerHTML = ''; pizzasSequencia = [];
    for(let i=0;i<qtd;i++){
      const card = document.createElement('div'); card.className='pizza-card'; card.dataset.index=i;
      card.style.background='#fff'; card.style.padding='12px'; card.style.marginBottom='10px'; card.style.border='1px solid #f3d1b0'; card.innerHTML = `
        <strong>Pizza ${i+1}</strong>
        <div class="row" style="margin-top:.6rem;">
          <label class="col"><input type="radio" name="tipoPizza${i}" value="inteira" checked> Inteira</label>
          <label class="col"><input type="radio" name="tipoPizza${i}" value="meia"> Meia / Meia</label>
        </div>
        <div class="sabor-inteiro" style="margin-top:.6rem;">
          <label>Sabor (inteira):
            <select class="sel-inteiro"><option value="">-- escolha --</option></select>
          </label>
        </div>
        <div class="sabor-meias" style="margin-top:.6rem; display:none;">
          <label>Metade 1:
            <select class="sel-meia1"><option value="">-- escolha --</option></select>
          </label>
          <label style="margin-top:.4rem;">Metade 2:
            <select class="sel-meia2"><option value="">-- escolha --</option></select>
          </label>
        </div>
      `;
      painelPizzas.appendChild(card);

      const selInteiro = card.querySelector('.sel-inteiro');
      const selMeia1 = card.querySelector('.sel-meia1');
      const selMeia2 = card.querySelector('.sel-meia2');
      saboresDisponiveis.forEach(s => { selInteiro.innerHTML += `<option value="${s}">${s}</option>`; selMeia1.innerHTML += `<option value="${s}">${s}</option>`; selMeia2.innerHTML += `<option value="${s}">${s}</option>`; });

      card.querySelectorAll(`input[name="tipoPizza${i}"]`).forEach(r => r.addEventListener('change', () => {
        const type = card.querySelector(`input[name="tipoPizza${i}"]:checked`).value;
        card.querySelector('.sabor-inteiro').style.display = type === 'inteira' ? 'block' : 'none';
        card.querySelector('.sabor-meias').style.display = type === 'meia' ? 'block' : 'none'; validarPainelPizzas();
      }));

      [selInteiro, selMeia1, selMeia2].forEach(sel => sel.addEventListener('change', validarPainelPizzas));
      pizzasSequencia.push({ tipo:'inteira', sabores:[''] });
    }
    validarPainelPizzas();
  }

  function validarPainelPizzas(){ const cards = painelPizzas.querySelectorAll('.pizza-card'); let valido=true; cards.forEach(card=>{
    const idx = parseInt(card.dataset.index); const tipo = card.querySelector(`input[name="tipoPizza${idx}"]:checked`).value;
    if(tipo==='inteira'){ const sel=card.querySelector('.sel-inteiro'); if(!sel.value) valido=false; } else { const sel1=card.querySelector('.sel-meia1'); const sel2=card.querySelector('.sel-meia2'); if(!sel1.value||!sel2.value) valido=false; }
  }); btnConfirmSabores.disabled = !valido; }

  function montarResumoFromPainel(){ pizzasSequencia=[]; const cards=painelPizzas.querySelectorAll('.pizza-card'); cards.forEach(card=>{
    const idx=parseInt(card.dataset.index); const tipo=card.querySelector(`input[name="tipoPizza${idx}"]:checked`).value; if(tipo==='inteira'){ const sel=card.querySelector('.sel-inteiro'); pizzasSequencia.push({ tipo:'inteira', sabores:[sel.value] }); } else { const sel1=card.querySelector('.sel-meia1'); const sel2=card.querySelector('.sel-meia2'); pizzasSequencia.push({ tipo:'meia', sabores:[sel1.value, sel2.value] }); }
  }); }

  function atualizarCarrinhoVisual(){ if(pedidos.length===0 && pizzasSequencia.length===0){ carrinhoDiv.style.display='none'; return; }
    let html='<ul>';
    pedidos.forEach((pedido,idx)=> html+=`<li><span>Pedido #${idx+1}: ${pedido.pizzas.length} pizza(s)</span> <button class="remove" data-index="${idx}">üóëÔ∏è</button></li>`);
    if(pizzasSequencia.length>0) html+=`<li><span><strong>Pedido em edi√ß√£o:</strong> ${pizzasSequencia.length} pizza(s)</span></li>`;
    html+='</ul>';
    carrinhoLista.innerHTML = html;

    let totalSemEntrega = 0; pedidos.forEach(p=> totalSemEntrega += p.pizzas.length * precoPizza);
    if(pizzasSequencia.length>0) totalSemEntrega += pizzasSequencia.length * precoPizza;
    // bebidas
    if(bebidasCheckbox.ref.checked) totalSemEntrega += precoRefrigerante;
    if(bebidasCheckbox.suco.checked) totalSemEntrega += precoSuco;

    const totalComEntrega = totalSemEntrega + (tipoEntregaAtual==='delivery' ? taxaEntregaAtual : 0);
    carrinhoTotal.textContent = formatMoney(totalComEntrega);
    carrinhoDiv.style.display = (totalComEntrega>0||totalSemEntrega>0) ? 'block' : 'none';
  }

  // remover pedido finalizado
  carrinhoLista.addEventListener('click', e => { if(e.target.classList.contains('remove')){ const idx=parseInt(e.target.dataset.index); if(!isNaN(idx)){ pedidos.splice(idx,1); atualizarPedidosListaVisivel(); atualizarCarrinhoVisual(); } } });

  // eventos sugest√£o
  btnCalcular.addEventListener('click', ()=>{
    const n = parseInt(numPessoasInput.value); if(isNaN(n)||n<=0) return alert('Informe um n√∫mero v√°lido de pessoas.');
    const a = apetiteSelect.value; const qtd = calcularPizzas(n,a);
    sugestaoQtdSpan.textContent = qtd; sugestaoPessoasSpan.textContent = n; sugestaoApetiteSpan.textContent = a; sugestaoContainer.style.display='block'; qtdManualInput.value=qtd;
  });

  usarSugestaoSelect.addEventListener('change', ()=>{ inputManualQtdDiv.style.display = usarSugestaoSelect.value==='nao' ? 'block' : 'none'; });

  btnConfirmPedido.addEventListener('click', ()=>{
    const n = parseInt(numPessoasInput.value); const a = apetiteSelect.value; const qtd = usarSugestaoSelect.value==='sim' ? calcularPizzas(n,a) : parseInt(qtdManualInput.value);
    if(isNaN(qtd)||qtd<=0) return alert('Digite uma quantidade v√°lida.');
    criarPainelPizzas(qtd); saboresSection.style.display='block'; sugestaoContainer.style.display='none'; window.scrollTo({ top: saboresSection.offsetTop-10, behavior:'smooth' });
  });

  btnConfirmSabores.addEventListener('click', ()=>{
    montarResumoFromPainel(); const novoPedido = { pizzas: JSON.parse(JSON.stringify(pizzasSequencia)) };
    pedidos.push(novoPedido); pizzasSequencia = []; painelPizzas.innerHTML=''; saboresSection.style.display='none'; atualizarPedidosListaVisivel(); atualizarCarrinhoVisual(); window.scrollTo({ top: 0, behavior:'smooth' });
  });

  // entrega: toggle
  document.getElementsByName('tipoEntregaCarrinho').forEach(r=> r.addEventListener('change', e=>{ tipoEntregaAtual = e.target.value; if(tipoEntregaAtual==='delivery'){ entregaDetalhes.style.display='block'; } else { entregaDetalhes.style.display='none'; taxaEntregaAtual=0; distanciaEstimativaKm=0; distanciaEstimativaSpan.textContent = distanciaEstimativaKm.toFixed(1); taxaEntregaValorSpan.textContent = formatMoney(0); } atualizarCarrinhoVisual(); }));

  // calcular taxa por dist√¢ncia
  function aplicarDistanciaKm(km){ if(isNaN(km)||km<0) return alert('Dist√¢ncia inv√°lida'); distanciaEstimativaKm = Number(km); taxaEntregaAtual = TAXA_FIXA + (distanciaEstimativaKm * TAXA_POR_KM); distanciaEstimativaSpan.textContent = distanciaEstimativaKm.toFixed(2); taxaEntregaValorSpan.textContent = formatMoney(taxaEntregaAtual); atualizarCarrinhoVisual(); }

  btnUsarDistanciaManual.addEventListener('click', ()=> aplicarDistanciaKm(parseFloat(distanciaManualInput.value)));

  // geolocaliza√ß√£o (GPS)
  btnUsarGeolocalizacao.addEventListener('click', ()=>{
    if(!navigator.geolocation) return alert('Geolocaliza√ß√£o n√£o suportada pelo navegador.');
    btnUsarGeolocalizacao.disabled = true; btnUsarGeolocalizacao.textContent = 'Obtendo localiza√ß√£o...';
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude; const lon = pos.coords.longitude; const km = haversineKm(lojaCoords.lat, lojaCoords.lon, lat, lon);
      aplicarDistanciaKm(km); btnUsarGeolocalizacao.disabled=false; btnUsarGeolocalizacao.textContent='Usar minha localiza√ß√£o (GPS)';
    }, err=>{ alert('N√£o foi poss√≠vel obter sua localiza√ß√£o: ' + (err.message||err.code)); btnUsarGeolocalizacao.disabled=false; btnUsarGeolocalizacao.textContent='Usar minha localiza√ß√£o (GPS)'; });
  });

  // geocodificar endere√ßo usando Nominatim (OpenStreetMap) - fallback se n√£o funcionar usu√°rio pode inserir km manual
  btnGeocodificarEndereco.addEventListener('click', async ()=>{
    const q = enderecoClienteInput.value.trim(); if(!q) return alert('Digite um endere√ßo para calcular.');
    btnGeocodificarEndereco.disabled=true; btnGeocodificarEndereco.textContent='Buscando...';
    try{
      const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q + ' Brasil');
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const data = await res.json();
      if(!data || data.length===0) { alert('Endere√ßo n√£o encontrado com precis√£o. Tente inserir a dist√¢ncia manualmente.'); }
      else {
        const first = data[0]; const lat = parseFloat(first.lat); const lon = parseFloat(first.lon); const km = haversineKm(lojaCoords.lat, lojaCoords.lon, lat, lon);
        aplicarDistanciaKm(km);
        alert('Endere√ßo localizado: ' + (first.display_name||q));
      }
    }catch(err){ console.error(err); alert('Erro ao consultar servi√ßo de geocodifica√ß√£o. Insira a dist√¢ncia manualmente.'); }
    btnGeocodificarEndereco.disabled=false; btnGeocodificarEndereco.textContent='Calcular pelo endere√ßo';
  });

  // finalizar pedido -> pagamento
  btnFinalizarPedido.addEventListener('click', ()=>{
    if(pedidos.length===0) return alert('N√£o h√° pedidos para finalizar.');
    pagamentoDiv.style.display='block'; pagamentoResumoUl.innerHTML=''; let totalSemEntrega=0;
    pedidos.forEach((p,i)=>{ const li=document.createElement('li'); li.textContent=`Pedido #${i+1}: ${p.pizzas.length} pizza(s)`; pagamentoResumoUl.appendChild(li);
      p.pizzas.forEach((pz,j)=>{ const li2=document.createElement('li'); li2.style.marginLeft='1rem'; if(pz.tipo==='inteira') li2.textContent=`Pizza ${j+1}: Inteira - ${pz.sabores[0]}`; else li2.textContent=`Pizza ${j+1}: Meia/Meia - ${pz.sabores[0]} / ${pz.sabores[1]}`; pagamentoResumoUl.appendChild(li2); }); totalSemEntrega += p.pizzas.length * precoPizza; });

    if(bebidasCheckbox.ref.checked) { totalSemEntrega += precoRefrigerante; const li = document.createElement('li'); li.textContent = 'Bebida: Refrigerante'; pagamentoResumoUl.appendChild(li); }
    if(bebidasCheckbox.suco.checked) { totalSemEntrega += precoSuco; const li = document.createElement('li'); li.textContent = 'Bebida: Suco'; pagamentoResumoUl.appendChild(li); }

    const totalComEntrega = totalSemEntrega + (tipoEntregaAtual==='delivery' ? taxaEntregaAtual : 0);
    totalPagamentoSpan.textContent = formatMoney(totalComEntrega);
    tempoEstimadoSpan.textContent = tipoEntregaAtual==='retirada' ? tempoRetirada : tempoDelivery;
    window.scrollTo({ top: pagamentoDiv.offsetTop-10, behavior:'smooth' });
  });

  // confirmar pagamento -> recibo
  btnConfirmarPagamento.addEventListener('click', ()=>{
    const nome = nomeClienteInput.value.trim(); if(!nome) return alert('Por favor, digite seu nome.');
    if(pedidos.length===0) return alert('N√£o h√° pedidos para confirmar.');
    const codigo = Math.floor(100000 + Math.random()*900000);
    const tempo = tipoEntregaAtual==='retirada' ? tempoRetirada : tempoDelivery;
    const totalSemEntrega = pedidos.reduce((acc,p)=>acc + p.pizzas.length * precoPizza, 0) + (bebidasCheckbox.ref.checked?precoRefrigerante:0) + (bebidasCheckbox.suco.checked?precoSuco:0);
    const totalComEntrega = totalSemEntrega + (tipoEntregaAtual==='delivery' ? taxaEntregaAtual : 0);

    reciboNome.textContent = nome; reciboCodigo.textContent = codigo; reciboTipoEntrega.textContent = tipoEntregaAtual==='retirada' ? 'Retirada na loja' : 'Delivery';
    reciboTempo.textContent = tempo; reciboTaxa.textContent = formatMoney(tipoEntregaAtual==='delivery'?taxaEntregaAtual:0); reciboTotal.textContent = formatMoney(totalComEntrega);
    reciboResumo.innerHTML = '';
    pedidos.forEach((p, idx)=>{ p.pizzas.forEach((pz,j)=>{ const li = document.createElement('li'); if(pz.tipo==='inteira') li.textContent = `Pedido #${idx+1} - Pizza ${j+1}: Inteira - ${pz.sabores[0]}`; else li.textContent = `Pedido #${idx+1} - Pizza ${j+1}: Meia/Meia - ${pz.sabores[0]} / ${pz.sabores[1]}`; reciboResumo.appendChild(li); }); });

    // reset state
    pedidos = []; pizzasSequencia = []; taxaEntregaAtual = 0; distanciaEstimativaKm = 0; tipoEntregaAtual = 'retirada'; enderecoClienteInput.value=''; distanciaManualInput.value = 0; distanciaEstimativaSpan.textContent = '0.0'; taxaEntregaValorSpan.textContent = formatMoney(0);

    pagamentoDiv.style.display='none'; saboresSection.style.display='none'; reciboDiv.style.display='block'; atualizarPedidosListaVisivel(); atualizarCarrinhoVisual(); window.scrollTo({ top: reciboDiv.offsetTop-10, behavior:'smooth' });
  });

  // inicializa√ß√£o
  function init(){ atualizarPedidosListaVisivel(); atualizarCarrinhoVisual(); }
  init();

})();
</script>
</body>
</html>
